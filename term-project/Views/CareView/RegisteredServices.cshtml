@{
    ViewData["Title"] = "Registered Services";
}

<h1>Registered Services</h1>

<table id="registeredServicesTable" class="table">
    <thead>
        <tr>
            <th>Service</th>
            <th>Customer Name</th>
            <th>Employee Name</th>
            <th>Schedule Time</th>
            <th>Invoice Status</th>
            <!-- Add more columns if needed -->
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

@section scripts {
    <script>
        $(function () {
            // Function to fetch and populate registered services
            function fetchRegisteredServices() {
                $.ajax({
                    url: '/Care/RegisteredServices',
                    type: 'POST', // Send a POST request
                    success: function (data) {
                        var tableBody = $('#registeredServicesTable tbody');
                        tableBody.empty(); // Clear existing table rows
                        console.log(data);
                        // Assuming all arrays have the same length
                        for (var i = 0; i < data.employeeNames.length; i++) {
                            var row = $('<tr></tr>');
                            row.append('<td>' + data.serviceNames[i] + '</td>');
                            row.append('<td>' + data.customerNames[i] + '</td>');
                            row.append('<td>' + data.employeeNames[i] + '</td>');
                            row.append('<td>' + data.serviceScheduleTimes[i] + '</td>'); // Assuming ServiceScheduleTimes is the correct array for IDs
                            var dropdownHtml = '<select class="invoiceStatusSelect" data-service-register-id="' + data.serviceRegisterIds[i] + '"';
                            dropdownHtml += (data.invoiceStatus[i] === 'SENT' ? ' disabled' : '') + '>';
                            dropdownHtml += '<option value="CREATED"' + (data.invoiceStatus[i] === 'CREATED' ? ' selected' : '') + '>CREATED</option>';
                            dropdownHtml += '<option value="IN PROGRESS"' + (data.invoiceStatus[i] === 'IN PROGRESS' ? ' selected' : '') + '>IN PROGRESS</option>';
                            dropdownHtml += '<option value="SENT"' + (data.invoiceStatus[i] === 'SENT' ? ' selected' : '') + '>SENT</option></select>';
                            row.append('<td>' + dropdownHtml + '</td>'); // Add dropdown with invoice status options
                            row.append('<td><button class="deleteServiceBtn" data-service-register-id="' + data.serviceRegisterIds[i] + '">Delete</button></td>'); // Add delete button with ServiceRegisterId
                            // Add more columns if needed
                            tableBody.append(row);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
            }
            
            // Call the function to fetch and populate registered services
            fetchRegisteredServices();
        
            // Function to handle delete button click
            $(document).on('click', '.deleteServiceBtn', function() {
                var serviceRegisterId = $(this).data('service-register-id');
                if (confirm("Are you sure you want to delete this service?")) {
                    $.ajax({
                        url: '/Care/DeleteService',
                        type: 'POST',
                        data: { serviceRegisterId: serviceRegisterId }, // Send ServiceRegisterId to the backend
                        success: function(response) {
                            // Refresh the table after deletion
                            fetchRegisteredServices();
                            alert('Service deleted successfully.');
                        },
                        error: function(xhr, status, error) {
                            console.log(xhr.responseText);
                            alert('Failed to delete service. Please try again.');
                        }
                    });
                }
            });

            // Function to handle change in invoice status
            $(document).on('change', '.invoiceStatusSelect', function() {
                var serviceRegisterId = $(this).data('service-register-id');
                var newStatus = $(this).val();
                $.ajax({
                    url: '/Care/UpdateInvoiceStatus',
                    type: 'POST',
                    data: { serviceRegisterId: serviceRegisterId, newStatus: newStatus }, // Send ServiceRegisterId and newStatus to the backend
                    success: function(response) {
                        alert('Invoice status updated successfully.');
                        // Disable dropdown if status is SENT
                        if (newStatus === 'SENT') {
                            $(this).prop('disabled', true);
                        }
                        
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.log(xhr.responseText);
                        alert('Failed to update invoice status. Please try again.');
                    }
                });
            });
        });
    </script>
}
